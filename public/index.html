<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <title>Norwegian Kosher List</title>

    <!-- Firebase App is always required and must be first -->

    <!-- Uncomment for production, comment for local development. -->
    <!-- <script defer src="/__/firebase/5.7.1/firebase-app.js"></script> -->
    <!-- <script defer src="/__/firebase/5.7.1/firebase-firestore.js"></script> -->

    <!-- Uncomment for local development, comment for production. -->
    <script src="https://www.gstatic.com/firebasejs/5.7.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.7.1/firebase-firestore.js"></script>

    <!-- include only the Firebase features as you need -->
    <!-- <script defer src="/__/firebase/5.7.1/firebase-auth.js"></script> -->
    <!-- <script defer src="/__/firebase/5.7.1/firebase-database.js"></script> -->
    <!-- <script defer src="/__/firebase/5.7.1/firebase-messaging.js"></script> -->
    <!-- <script defer src="/__/firebase/5.7.1/firebase-storage.js"></script> -->

    <!-- initialize the SDK after all desired features are loaded -->
    <!-- Uncomment for production, comment for local development. -->
    <!-- <script defer src="/__/firebase/init.js"></script> -->

    <!-- KApp functions -->
    <script defer src="data.js"></script>
    <script defer src="kappDb.js"></script>
    <script defer src="kappHtml.js"></script>

    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div id="message">
        <h2>Norwegian Kosher List</h2>
        <p class="info" id="metadata"></p>
        <p class="info">To search, write a text and press enter</p>
    </div>

    <div id="searchBar"></div>
    <div id="products"></div>

    <script>
        // Use local or Firestore database.
        const useLocalDb = true;

        function locationToObject() {
            let kv;
            return location.search.slice(1).split("&").reduce((acc, curr) => {
                kv = curr.split("=");
                acc[kv[0]] = kv[1];
                return acc;
            }, {});
        }

        document.addEventListener('DOMContentLoaded', function () {
            // The Firebase SDK is initialized and available here!
            // firebase.auth().onAuthStateChanged(user => { });
            // firebase.database().ref('/path/to/ref').on('value', snapshot => { });
            // firebase.messaging().requestPermission().then(() => { });
            // firebase.storage().ref('/path/to/ref').getDownloadURL().then(() => { });

            try {
                // document.getElementById("metadata").innerHTML = "version:" + data["metadata"].version + ", updated:" + data["metadata"].updated_ts;
                const fs = useLocalDb ? {} : initFirestore(firebase);

                console.log(data["metadata"]);

                const query = locationToObject()
                console.log("HREF is", query);

                initKAppDB(fs, query.id, query.showids);

                // const app = firebase.app();
                // const features = ["auth", "database", "messaging", "storage", "firestore"].filter(
                //     (feature) => typeof app[feature] === 'function'
                // );
                // document.getElementById('load').innerHTML = `Firebase SDK loaded`;
                // document.getElementById('load').innerHTML = `Firebase SDK loaded with ${features.join(', ')}`;
            } catch (e) {
                console.error(e);
                // document.getElementById('load').innerHTML = 'Error loading the Firebase SDK, check the console.';
            }
        });

        function initKAppDB(fs, uid = 0, showids = false) {
            const db = database();

            const productsRootNode = document.getElementById("products");
            const searchBarRootNode = document.getElementById("searchBar");

            (useLocalDb ? db.initLocalDb() : db.initFirestoreDb(fs))
            .then((ready) => {
                displaySearchBar(searchBarRootNode, productsRootNode, db, uid, showids);
            });
        }

        function initFirestore(firebase) {
            const config = {
                projectId: "kappdb-6fb1e",
            };

            // Only call this when developing on local machine.
            if (window.location.hostname === "") {
                firebase.initializeApp(config);
            }

            // Initialize Cloud Firestore through Firebase
            const db = firebase.firestore();

            // Disable deprecated features
            db.settings({
                timestampsInSnapshots: true
            });

            return db;
        }
    </script>

</body>

</html>